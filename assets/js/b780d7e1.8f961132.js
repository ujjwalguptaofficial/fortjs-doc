"use strict";(self.webpackChunkmy=self.webpackChunkmy||[]).push([[3629],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var r=n(7294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,s=function(e,t){if(null==e)return{};var n,r,s={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var p=r.createContext({}),l=function(e){var t=r.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=l(e.components);return r.createElement(p.Provider,{value:t},e.children)},c="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,s=e.mdxType,a=e.originalType,p=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),c=l(n),d=s,m=c["".concat(p,".").concat(d)]||c[d]||h[d]||a;return n?r.createElement(m,o(o({ref:t},u),{},{components:n})):r.createElement(m,o({ref:t},u))}));function m(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var a=n.length,o=new Array(a);o[0]=d;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i[c]="string"==typeof e?e:s,o[1]=i;for(var l=2;l<a;l++)o[l]=n[l];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8701:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>l});var r=n(7462),s=(n(7294),n(3905));const a={sidebar_position:2,title:"Passport JWT Authentication",keywords:["Fort.js","Passport.js","JWT Authentication","Web Security","Fort Framework"],description:"Implement secure JWT authentication in Fort.js using Passport.js. Enhance your web application's security and user authentication with stateless persistence."},o="Passport JWT Authentication",i={unversionedId:"authentication/passport/passport-jwt",id:"authentication/passport/passport-jwt",title:"Passport JWT Authentication",description:"Implement secure JWT authentication in Fort.js using Passport.js. Enhance your web application's security and user authentication with stateless persistence.",source:"@site/docs/authentication/passport/passport-jwt.md",sourceDirName:"authentication/passport",slug:"/authentication/passport/passport-jwt",permalink:"/docs/authentication/passport/passport-jwt",draft:!1,editUrl:"https://github.com/ujjwalguptaofficial/fortjs-doc/tree/main/docs/authentication/passport/passport-jwt.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"Passport JWT Authentication",keywords:["Fort.js","Passport.js","JWT Authentication","Web Security","Fort Framework"],description:"Implement secure JWT authentication in Fort.js using Passport.js. Enhance your web application's security and user authentication with stateless persistence."},sidebar:"tutorialSidebar",previous:{title:"Passport",permalink:"/docs/authentication/passport/"},next:{title:"Component",permalink:"/docs/component/"}},p={},l=[{value:"installation",id:"installation",level:2},{value:"Registration",id:"registration",level:2},{value:"Login",id:"login",level:2},{value:"Protected routes",id:"protected-routes",level:2}],u={toc:l},c="wrapper";function h(e){let{components:t,...n}=e;return(0,s.kt)(c,(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"passport-jwt-authentication"},"Passport JWT Authentication"),(0,s.kt)("p",null,"So far, we've utilized ",(0,s.kt)("strong",{parentName:"p"},"sessions")," for user persistence, but an alternative is ",(0,s.kt)("strong",{parentName:"p"},"JWT Authentication"),", offering stateless persistence. To implement this, we employ the ",(0,s.kt)("a",{parentName:"p",href:"https://www.passportjs.org/packages/passport-jwt/"},"JWT strategy"),"."),(0,s.kt)("p",null,"Let's install the strategy and register it - "),(0,s.kt)("h2",{id:"installation"},"installation"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"npm i passport-jwt\n")),(0,s.kt)("h2",{id:"registration"},"Registration"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-js",metastring:"title=src/index",title:"src/index"},"\nimport * as path from \"path\";\nimport { Fort } from \"fortjs\";\nimport { routes } from \"@/routes\";\nimport { PassportAuth } from \"fortjs-passport\";\nimport { Strategy } from 'passport-local';\nimport { Strategy as JwtStrategy, ExtractJwt } from 'passport-jwt';\nimport { db } from \"./services/db\";\n\nexport const createApp = async () => {\n    Fort.routes = routes;\n\n    // Initiate Passport authentication\n    PassportAuth.init();\n\n    //highlight-start\n    // register the jwt stategy\n    const opts = {} as any;\n    opts.jwtFromRequest = ExtractJwt.fromHeader('authorization');\n    opts.secretOrKey = 'thisisthesecretkey';\n    PassportAuth.passport.use('jwt', new JwtStrategy(opts,\n        function (jwt_payload, done) {\n            const user = db.users.find(user => user.id === jwt_payload.id);\n            if (!user) {\n                return done(null, false, {\n                    message: 'Not authenticated'\n                });\n            }\n\n            return done(null, user);\n        }\n    ));\n    //highlight-end\n\n\n    // Register the local strategy for user login\n    PassportAuth.passport.use('local', new Strategy({\n        usernameField: 'email',\n        passwordField: 'password'\n    },\n        function (email, password, done) {\n            const user = db.users.find(user => user.emailId === email);\n            if (!user) { return done(null, false); }\n            if (user.password !== password) { return done(null, false); }\n\n            return done(null, user);\n        }\n    ));\n\n    // Create the Fort application\n    await Fort.create();\n\n    // Set the application URL\n    process.env.APP_URL = `http://localhost:${Fort.port}`;\n};\n\nif (process.env.NODE_ENV !== \"test\") {\n    createApp().then(() => {\n        Fort.logger.debug(`Your fort is located at address - ${process.env.APP_URL}`);\n    }).catch(err => {\n        console.error(err);\n    });\n}\n")),(0,s.kt)("p",null,"In the highlighted section, the JWT strategy is registered in PassportJS. This allows authentication using JSON Web Tokens (JWT) in the Fort.js application. The strategy inernally extracts the JWT from the request header and verifies it using the provided secret key. If the token is valid, it retrieves the user information from the database based on the user ID stored in the JWT payload. If the user is found, authentication is successful; otherwise, it returns an error message indicating that the user is not authenticated."),(0,s.kt)("h2",{id:"login"},"Login"),(0,s.kt)("p",null,"In case of jwt authentication - we need to create the token and send it to client either in response data or via headers."),(0,s.kt)("p",null,"Let's change the ",(0,s.kt)("inlineCode",{parentName:"p"},"doLogin")," method code from our previous example to generate the token and send the token via headers. "),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-js"},'import { http, Controller, viewResult } from "fortjs"\nimport { auth } from "fortjs-passport";\n\nexport class AuthController extends Controller {\n\n    @http.post("/login")\n    // apply local guard which will handle the login and pass user in the method\n    @guards(auth.guard(\'local\'))\n    async doLogin() {\n        const { user } = this.request as any;\n\n        //highlight-start\n        const token = jwt.sign(user, \'thisisthesecretkey\');\n        this.response.setHeader("authorization", token);\n        //highlight-end\n\n        return textResult(`Welcome ${user.name}`);\n    }\n}\n')),(0,s.kt)("p",null,"In the highlighted section, the jwt.sign function is used to generate a JWT token for the authenticated user (user) using the provided secret key ('thisisthesecretkey'). The generated token is then set in the response header with the key \"authorization\". This allows the client to receive the token in the response headers after a successful login, enabling further authenticated requests using this token."),(0,s.kt)("h2",{id:"protected-routes"},"Protected routes"),(0,s.kt)("p",null,"In the session example - we have used ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.shield('isAuthenticated')")," to protect the shield, but in case of jwt auth - it won't work alone as for every request the token needs to be parsed and then extract the payload from the token which means calling ",(0,s.kt)("inlineCode",{parentName:"p"},"jwt-strategy")," for each request."),(0,s.kt)("p",null,"For calling ",(0,s.kt)("inlineCode",{parentName:"p"},"jwt-strategy")," : we will use ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.shield")," and pass the strategy name ",(0,s.kt)("inlineCode",{parentName:"p"},"jwt"),"."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-js"},'import { Controller, shields, http, jsonResult } from "fortjs";\nimport { auth } from \'fortjs-passport\';\n\n//highlight-start\n@shields(auth.shield("jwt",{ session: false}))\n//highlight-end\nexport class ProtectedController extends Controller {\n    \n    @http.get("/user")\n    getUser(){\n        // isAuthenticated shield pass `user` via data.\n        const { user } = this.data;\n\n        // const user = this.request[\'user\'] - this is how you would get user in expressjs\n\n        return jsonResult(user);\n    }\n}\n')),(0,s.kt)("p",null,"In the highlighted section, ",(0,s.kt)("inlineCode",{parentName:"p"},'@shields(auth.shield("jwt", { session: false }))')," is used to apply the JWT authentication shield to protect the route. The ",(0,s.kt)("inlineCode",{parentName:"p"},"{ session: false }")," option is passed to the shield to ensure that the session is not used, as JWT is a stateless authentication method. This shield validates the incoming JWT token for each request and extracts the user information for further processing in the route handler."),(0,s.kt)("admonition",{type:"tip"},(0,s.kt)("p",{parentName:"admonition"},"You can store the ",(0,s.kt)("inlineCode",{parentName:"p"},"auth.shield")," result in a variable and use it wherever its needed. For example - "),(0,s.kt)("pre",{parentName:"admonition"},(0,s.kt)("code",{parentName:"pre",className:"language-js"},'const JWT_SHIELD = auth.shield("jwt",{ session: false});\n')),(0,s.kt)("p",{parentName:"admonition"},"and then use it - "),(0,s.kt)("pre",{parentName:"admonition"},(0,s.kt)("code",{parentName:"pre",className:"language-js"},"@shields(JWT_SHIELD)\nexport class ProtectedController extends Controller {\n}\n"))))}h.isMDXComponent=!0}}]);